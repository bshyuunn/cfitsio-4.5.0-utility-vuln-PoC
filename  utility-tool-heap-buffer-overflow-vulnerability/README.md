# Heap Buffer Overflow in CFITSIO fits_parse_card Function During FITS Header Parsing

## 01. Summary
A heap-based buffer overflow vulnerability exists in the fits_parse_card() function of the CFITSIO library. When processing a malformed FITS file (especially certain header keyword information), the function may read data beyond the allocated buffer boundary. This can cause the program to crash or potentially allow attackers to execute arbitrary code.

## 02. Details
### 02.1 Vulnerability Overview
- Affected File: fvrf_key.c
- Function: fits_parse_card()
- Line of Code: Around line 43 (while(isspace((int)*p) && i >= 0) { ... })

### 02.2 Root Cause
- The function tries to remove trailing spaces from the keyword name kname using a loop:
```c
while(isspace((int)*p) && i >= 0) {
    *p = '\0';
    p--;
    i--;
}
```
If kname is unexpectedly short or filled with spaces (and not properly terminated), the pointer p can move beyond the start of kname. This triggers a read outside the valid memory region when calling isspace((int)*p).

### 02.3 AddressSanitizer (ASan) Report
```
[AFL++ 9c0ca34ee430] ~/cfitsio-4.5.0/SANITIZER_BUILD/bin # ./fitsverify /root/testcase/access_violation_0xxxxxxxxxx732_0xxxxxxxxxx446_1
 
              fitsverify 4.22 (CFITSIO V4.050)              
              --------------------------------              
 
 
File: /root/testcase/access_violation_0xxxxxxxxxx732_0xxxxxxxxxx446_1

2 Header-Data Units in this file.
 
=================== HDU 1: Primary Array ===================
 
*** Error:   The header fill area is not totally filled with blanks.
*** Warning: Invalid CHECKSUM means header has been modified. (DATASUM is OK) 
 
 9 header keywords
 
 Null data array; NAXIS = 0 
 
=================== HDU 2: BINARY Table ====================
 
*** Error:   Byte #80 in Card#10 is a null(\0).
*** Error:   Keyword #11: Name "" contains char "" which is not upper case
             letter, digit, "-", or "_".
*** Error:   Keyword #13, TTYPE3: String "ZZEROï¿½"  contains non-text characters.
=================================================================
==28==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60e000000f1f at pc 0x555555785cef bp 0x7fffffffdeb0 sp 0x7fffffffdea8
READ of size 1 at 0x60e000000f1f thread T0
    #0 0x555555785cee in fits_parse_card /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_key.c:43:11
    #1 0x5555557413b1 in init_hdu /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:393:5
    #2 0x55555573c0ef in verify_fits /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:125:9
    #3 0x55555572ac17 in ftverify_work /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/ftverify.c:369:20
    #4 0x5555557294cd in main /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fitsverify.c:184:17
    #5 0x7ffff7c7ed8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)
    #6 0x7ffff7c7ee3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)
    #7 0x555555650b34 in _start (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0xfcb34) (BuildId: fb1b5d94bf2c5eed)

0x60e000000f1f is located 1 bytes before 160-byte region [0x60e000000f20,0x60e000000fc0)
allocated by thread T0 here:
    #0 0x5555556ea95e in malloc (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0x19695e) (BuildId: fb1b5d94bf2c5eed)
    #1 0x555555741049 in init_hdu /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:384:38
    #2 0x55555573c0ef in verify_fits /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:125:9
    #3 0x55555572ac17 in ftverify_work /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/ftverify.c:369:20
    #4 0x5555557294cd in main /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fitsverify.c:184:17
    #5 0x7ffff7c7ed8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)

SUMMARY: AddressSanitizer: heap-buffer-overflow /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_key.c:43:11 in fits_parse_card
Shadow bytes around the buggy address:
  0x60e000000c80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x60e000000d00: 00 00 00 00 fa fa fa fa fa fa fa fa 00 00 00 00
  0x60e000000d80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x60e000000e00: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
  0x60e000000e80: 00 00 00 00 00 00 00 00 00 00 00 00 fa fa fa fa
=>0x60e000000f00: fa fa fa[fa]00 00 00 00 00 00 00 00 00 00 00 00
  0x60e000000f80: 00 00 00 00 00 00 00 00 fa fa fa fa fa fa fa fa
  0x60e000001000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x60e000001080: 00 00 00 00 fa fa fa fa fa fa fa fa 00 00 00 00
  0x60e000001100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x60e000001180: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==28==ABORTING
```
ASan detected a read operation beyond the allocated heap buffer boundary at line 43 in fits_parse_card().

### 02.4 Vulnerable Code Flow
1. The function copies up to 8 bytes from card into kname:
2. It then attempts to strip trailing spaces from kname by moving backward from &kname[7].
3. If kname is malformed or shorter than expected, the loop can move p before the start of kname.
4. A call to isspace((int)*p) on an invalid pointer triggers a heap-based buffer overflow.

## 03. PoC
### 03.1 Environment
- OS: Ubuntu 22.04.4 LTS
- CFITSIO Version: 4.50

### 03.2 Steps to Reproduce
The vulnerability can be reproduced using the fitsverify tool, which is automatically generated when building CFITSIO with make.
```bash
$ wget https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio-4.5.0.tar.gz
$ tar -zxvf cfitsio-4.5.0.tar.gz
$ mkdir install

$ cd cfitsio-4.5.0
$ ./configure --prefix=../install
$ make
$ make install

$ cd ../install/bin
$ ./fitsverify poc.fits
```

## 04. Impact
- Scope: Affects any application or utility (e.g., fitsverify) built with CFITSIO that processes untrusted FITS files.
- Severity: Heap memory corruption can cause crashes (denial of service). In some scenarios, it can potentially lead to remote code execution if exploited by a crafted malicious FITS file.

## 05. Recommended Fix
Modify the loop to ensure that p does not move before the start of kname, e.g.:

```diff
- while(isspace((int)*p) && i >= 0) {
+ while(i >= 0 && isspace((int)*p)) {
    *p = '\0';
    p--;
    i--;
}
```