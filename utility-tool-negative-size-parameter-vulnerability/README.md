# Negative Size Parameter in CFITSIO get_str() Function Leading to DoS

## 01. Summary
https://github.com/HEASARC/cfitsio/blob/0d29909cdab7618e996b7a3d8414ca5dadd7bbe8/utilities/fvrf_key.c#L188C1-L226C2
```c
p--;
if(*p != '\'') *stat |= NO_TRAIL_QUOTE; 
pi++;	    
nchar = p - pi ;     /* excluding the ' */ 
strncpy(kvalue,pi,nchar);
```

A negative-size-param error occurs in the get_str function (fvrf_key.c:218:5). When processing a string key from a FITS file, if the string key starts with a NULL byte, the size calculation (nchar = p - pi) results in -1.


## 02. Details
### 02.1 Vulnerability Overview
- Affected File: fvrf_key.c
- Function: get_str()
- Line of Code: Around line 218 (strncpy(kvalue,pi,nchar))

### 02.2 Root Cause
```c
p = *pt;
pi = p;
p++;
prev = 'a';
while(*p != '\0') { 
    if( !isprint((int)*p) )*stat |= BAD_STR;
    if(prev == '\'' && *p != '\'') break;
    if(prev == '\'' && *p == '\'') {    /* skip the '' */
        p++;
        prev = 'a';
    } 
    else {
            prev = *p;
            p++;
    }
}
p--;
if(*p != '\'') *stat |= NO_TRAIL_QUOTE; 
pi++;	    
nchar = p - pi ;     /* excluding the ' */ 
strncpy(kvalue,pi,nchar);
```
The get_str function removes the single quotes from a string key of the form 'string data' and copies the result to kvalue. However, if the string data starts with a NULL byte, then pi becomes 1 greater than p. This causes the operation nchar = p - pi to produce -1.

### 02.3 AddressSanitizer (ASan) Report
```
==516==ERROR: AddressSanitizer: negative-size-param: (size=-1)
    #0 0x5555556d50a9 in strncpy (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0x1810a9) (BuildId: fb1b5d94bf2c5eed)
    #1 0x555555786d30 in get_str /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_key.c:218:5
    #2 0x55555578405c in fits_parse_card /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_key.c:138:6
    #3 0x5555557413b1 in init_hdu /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:393:5
    #4 0x55555573c0ef in verify_fits /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:125:9
    #5 0x55555572ac17 in ftverify_work /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/ftverify.c:369:20
    #6 0x5555557294cd in main /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fitsverify.c:184:17
    #7 0x7ffff7c7ed8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)
    #8 0x7ffff7c7ee3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)
    #9 0x555555650b34 in _start (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0xfcb34) (BuildId: fb1b5d94bf2c5eed)

0x60e000000250 is located 80 bytes inside of 160-byte region [0x60e000000200,0x60e0000002a0)
allocated by thread T0 here:
    #0 0x5555556ea95e in malloc (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0x19695e) (BuildId: fb1b5d94bf2c5eed)
    #1 0x555555741049 in init_hdu /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:384:38
    #2 0x55555573c0ef in verify_fits /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fvrf_head.c:125:9
    #3 0x55555572ac17 in ftverify_work /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/ftverify.c:369:20
    #4 0x5555557294cd in main /root/cfitsio-4.5.0/SANITIZER_BUILD/../utilities/fitsverify.c:184:17
    #5 0x7ffff7c7ed8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f) (BuildId: 490fef8403240c91833978d494d39e537409b92e)

SUMMARY: AddressSanitizer: negative-size-param (/root/cfitsio-4.5.0/SANITIZER_BUILD/bin/fitsverify+0x1810a9) (BuildId: fb1b5d94bf2c5eed) in strncpy
==516==ABORTING
```

### 02.4 Vulnerable Code Flow
```c
p = *pt;
pi = p;
p++;
```
The logic first sets both p and pi to the address of the string key, then increments p by 1.

```c
while(*p != '\0') { 
    if( !isprint((int)*p) )*stat |= BAD_STR;
    if(prev == '\'' && *p != '\'') break;
    if(prev == '\'' && *p == '\'') {    /* skip the '' */
        p++;
        prev = 'a';
    } 
    else {
            prev = *p;
            p++;
    }
}
```
It then iterates in a while loop until a NULL or a single quote (') is encountered, incrementing p. However, because *p is already NULL, the loop does not run at all. Thus, p remains at pi + 1.

```c
p--;
if(*p != '\'') *stat |= NO_TRAIL_QUOTE; 
pi++;	    
nchar = p - pi ;     /* excluding the ' */
```
Afterwards, p is decremented by 1, and pi is incremented by 1.
- Since p was pi + 1, decrementing p by 1 and incrementing pi by 1 makes pi become p + 1.
- As a result, nchar = p - pi becomes -1.

## 03. PoC
### 03.1 Environment
- OS: Ubuntu 22.04.4 LTS
- CFITSIO Version: 4.50

### 03.2 Steps to Reproduce
The vulnerability can be reproduced using the `fitsverify` tool, which is automatically generated when building CFITSIO with make.

You can reproduce this vulnerability using the fitsverify tool, which is automatically generated during the build process:
```
$ wget https://heasarc.gsfc.nasa.gov/FTP/software/fitsio/c/cfitsio-4.5.0.tar.gz
$ tar -zxvf cfitsio-4.5.0.tar.gz
$ mkdir install

$ cd cfitsio-4.5.0
$ ./configure --prefix=../install
$ make
$ make install

$ cd ../install/bin
$ ./fitsverify poc.fits
```

## 04. Impact
Because the strncpy function cannot handle a negative size parameter, and the input starts with NULL (which strncpy would not copy), it cannot be exploited to cause a buffer overflow. Hence, this is likely classified as a simple DoS vulnerability.
